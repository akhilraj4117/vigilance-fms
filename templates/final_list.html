{% extends "base.html" %}
{% block title %}Final Transfer List - JPHN Transfer{% endblock %}

{% block content %}
<div class="page-container">
    <div class="page-header">
        <h1><i class="fas fa-check-double"></i> Final Transfer List</h1>
        <div class="header-actions">
            <button type="button" class="btn btn-info" onclick="showExcluded()">
                <i class="fas fa-user-minus"></i> Not Included
            </button>
            <div class="export-dropdown">
                <button class="btn btn-secondary dropdown-toggle" onclick="toggleDropdown('exportDropdownFinal')">
                    <i class="fas fa-download"></i> Export <i class="fas fa-caret-down"></i>
                </button>
                <div class="dropdown-menu" id="exportDropdownFinal">
                    <a href="javascript:void(0)" onclick="exportCSV()" class="dropdown-item">
                        <i class="fas fa-file-csv"></i> CSV
                    </a>
                    <a href="javascript:void(0)" onclick="exportExcel()" class="dropdown-item">
                        <i class="fas fa-file-excel"></i> Excel
                    </a>
                    <a href="javascript:void(0)" onclick="exportWord()" class="dropdown-item">
                        <i class="fas fa-file-word"></i> Word
                    </a>
                    <a href="javascript:void(0)" onclick="exportPDF()" class="dropdown-item">
                        <i class="fas fa-file-pdf"></i> PDF
                    </a>
                </div>
            </div>
            <form method="POST" action="{{ url_for('clear_final_list') }}" style="display:inline" 
                  onsubmit="return confirm('Clear ALL final transfers? This cannot be undone!')">
                <button type="submit" class="btn btn-danger">
                    <i class="fas fa-trash"></i> Clear All
                </button>
            </form>
            <form method="POST" action="{{ url_for('revert_to_draft') }}" style="display:inline" 
                  onsubmit="return confirm('Revert to Draft List? This will remove the final list and allow you to make changes in the draft.')">
                <button type="submit" class="btn btn-warning">
                    <i class="fas fa-undo"></i> Revert to Draft
                </button>
            </form>
        </div>
    </div>
    
    <div class="filter-section">
        <form method="GET" class="filter-form">
            <div class="form-group">
                <label for="from_district">From District</label>
                <select name="from_district" id="from_district" class="form-control" onchange="this.form.submit()">
                    <option value="">All Districts</option>
                    {% for d in districts %}
                    <option value="{{ d }}" {% if d == from_district %}selected{% endif %}>{{ d }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="form-group">
                <label for="to_district">To District</label>
                <select name="to_district" id="to_district" class="form-control" onchange="this.form.submit()">
                    <option value="">All Districts</option>
                    {% for d in districts %}
                    <option value="{{ d }}" {% if d == to_district %}selected{% endif %}>{{ d }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="form-group search-group">
                <label for="tableSearch">Search</label>
                <div class="search-box-inline">
                    <i class="fas fa-search"></i>
                    <input type="text" id="tableSearch" class="form-control" placeholder="Search by Name or PEN..." onkeyup="filterTable()">
                    <button type="button" class="search-clear" onclick="clearSearch()" title="Clear">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
            {% if from_district or to_district %}
            <a href="{{ url_for('final_list') }}" class="btn btn-secondary">
                <i class="fas fa-times"></i> Clear Filters
            </a>
            {% endif %}
        </form>
    </div>
    
    <div class="table-container">
        <table class="data-table final-table" id="finalTable">
            <thead>
                <tr>
                    <th>Sl No</th>
                    <th class="sortable" onclick="sortTable(document.getElementById('finalTable'), 1, 'number')">PEN</th>
                    <th class="sortable" onclick="sortTable(document.getElementById('finalTable'), 2, 'text')">Name</th>
                    <th class="sortable" onclick="sortTable(document.getElementById('finalTable'), 3, 'text')">Institution</th>
                    <th class="sortable" onclick="sortTable(document.getElementById('finalTable'), 4, 'text')">From District</th>
                    <th class="sortable" onclick="sortTable(document.getElementById('finalTable'), 5, 'text')">To District</th>
                    <th class="sortable" onclick="sortTable(document.getElementById('finalTable'), 6, 'date')">District Join Date</th>
                    <th class="sortable" onclick="sortTable(document.getElementById('finalTable'), 7, 'duration')">Duration</th>
                    <th class="sortable" onclick="sortTable(document.getElementById('finalTable'), 8, 'text')">Weightage</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for t in transfers %}
                <tr class="{% if t[7] == 'Yes' %}row-weightage{% endif %}">
                    <td>{{ (page - 1) * per_page + loop.index }}</td>
                    <td>{{ t[0] }}</td>
                    <td>{{ t[1] }}</td>
                    <td>{{ t[2] }}</td>
                    <td>{{ t[3] }}</td>
                    <td class="to-district highlight">{{ t[4] }}</td>
                    <td>{{ t[5] or '-' }}</td>
                    <td>{{ format_duration(t[6]) }}</td>
                    <td>
                        {% if t[7] == 'Yes' %}
                        <span class="badge badge-warning" title="{{ t[8] or '' }}">Yes</span>
                        {% else %}
                        <span class="badge badge-secondary">No</span>
                        {% endif %}
                    </td>
                    <td class="action-cell">
                        <form method="POST" action="{{ url_for('delete_from_final', pen=t[0]) }}" 
                              style="display:inline" onsubmit="return confirm('Delete this transfer from final list?')">
                            <button type="submit" class="btn btn-sm btn-danger" title="Delete">
                                <i class="fas fa-trash"></i>
                            </button>
                        </form>
                    </td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="10" class="no-data">
                        <i class="fas fa-inbox"></i>
                        <p>No confirmed transfers found</p>
                        <a href="{{ url_for('draft_list') }}" class="btn btn-primary">View Draft List</a>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    
    <div class="table-footer">
        <span class="record-count">Showing {{ transfers|length }} of {{ total_count }} confirmed transfer(s) (Page {{ page }} of {{ total_pages }})</span>
        
        {% if total_pages > 1 %}
        <div class="pagination">
            {% if page > 1 %}
            <a href="{{ url_for('final_list', page=1, from_district=from_district, to_district=to_district) }}" class="page-btn" title="First Page">
                <i class="fas fa-angle-double-left"></i>
            </a>
            <a href="{{ url_for('final_list', page=page-1, from_district=from_district, to_district=to_district) }}" class="page-btn" title="Previous Page">
                <i class="fas fa-angle-left"></i>
            </a>
            {% endif %}
            
            {% set start_page = [1, page - 2]|max %}
            {% set end_page = [total_pages, page + 2]|min %}
            
            {% for p in range(start_page, end_page + 1) %}
            <a href="{{ url_for('final_list', page=p, from_district=from_district, to_district=to_district) }}" 
               class="page-btn {% if p == page %}active{% endif %}">{{ p }}</a>
            {% endfor %}
            
            {% if page < total_pages %}
            <a href="{{ url_for('final_list', page=page+1, from_district=from_district, to_district=to_district) }}" class="page-btn" title="Next Page">
                <i class="fas fa-angle-right"></i>
            </a>
            <a href="{{ url_for('final_list', page=total_pages, from_district=from_district, to_district=to_district) }}" class="page-btn" title="Last Page">
                <i class="fas fa-angle-double-right"></i>
            </a>
            {% endif %}
        </div>
        {% endif %}
    </div>
    
    {% if transfers %}
    <div class="summary-section">
        <h3><i class="fas fa-chart-pie"></i> Transfer Summary</h3>
        <div id="transfer-summary" class="transfer-summary-grid">
            <!-- Will be populated dynamically -->
        </div>
    </div>
    {% endif %}
</div>

{% endblock %}

{% block extra_js %}
<script>
// Transfer data for export
const transferData = [
    {% for t in transfers %}
    {
        pen: {{ t[0]|tojson }},
        name: {{ t[1]|tojson }},
        institution: {{ t[2]|tojson }},
        fromDistrict: {{ t[3]|tojson }},
        toDistrict: {{ t[4]|tojson }},
        joinDate: {{ t[5]|tojson }},
        duration: {{ t[6]|tojson }},
        weightage: {{ t[7]|tojson }},
        weightageDetails: {{ t[8]|tojson }}
    }{% if not loop.last %},{% endif %}
    {% endfor %}
];

const transferType = {{ session.get('transfer_type', 'general')|tojson }};
const transferYear = {{ session.get('year', '')|tojson }};
const transferMonth = {{ session.get('month', '')|tojson }};
const listType = 'Final';
const districts = {{ districts|tojson }};

function formatDuration(days) {
    if (!days) return '-';
    const years = Math.floor(days / 365);
    const months = Math.floor((days % 365) / 30);
    const d = days % 30;
    let result = '';
    if (years > 0) result += years + 'Y ';
    if (months > 0) result += months + 'M ';
    if (d > 0) result += d + 'D';
    return result.trim() || '-';
}

function getFileName(ext) {
    const date = new Date().toISOString().slice(0, 10).replace(/-/g, '');
    return `final_transfer_list_${date}.${ext}`;
}

function exportCSV() {
    // Fetch ALL data from server
    fetch('/final/export-data', { headers: { 'X-Requested-With': 'XMLHttpRequest' } })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            alert('Error: ' + data.error);
            return;
        }
        
        const allTransfers = data.transfers;
        const headers = ['Sl No', 'PEN', 'Name', 'Institution', 'From District', 'To District', 'Duration', 'Weightage'];
        let csv = headers.join(',') + '\n';
        
        allTransfers.forEach((t, i) => {
            const row = [
                i + 1,
                t.pen,
                `"${(t.name || '').replace(/"/g, '""')}"`,
                `"${(t.institution || '').replace(/"/g, '""')}"`,
                t.fromDistrict,
                t.toDistrict,
                formatDuration(t.duration),
                t.weightage || 'No'
            ];
            csv += row.join(',') + '\n';
        });
        
        const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8;' });
        saveAs(blob, getFileName('csv'));
    })
    .catch(err => {
        console.error('Export error:', err);
        alert('Error exporting CSV');
    });
}

function exportExcel() {
    // Fetch ALL data from server
    fetch('/final/export-data', { headers: { 'X-Requested-With': 'XMLHttpRequest' } })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            alert('Error: ' + data.error);
            return;
        }
        
        const allTransfers = data.transfers;
        const wb = XLSX.utils.book_new();
        
        // Create data grouped by district
        const groupedData = {};
        allTransfers.forEach(t => {
            if (!groupedData[t.fromDistrict]) groupedData[t.fromDistrict] = [];
            groupedData[t.fromDistrict].push(t);
        });
        
        // Create worksheet data
        const wsData = [];
        
        // Header rows
        wsData.push(['Government of Kerala']);
        wsData.push(['Department: Health Services']);
        let titleText = transferType === 'regular' 
            ? `Regular Transfer for Junior Public Health Nurse Gr. I - ${transferMonth} ${transferYear}`
            : `Norms Based General Transfer for Junior Public Health Nurse Gr. I - ${transferYear}`;
        wsData.push([titleText]);
        wsData.push([`${listType} Transfer List`]);
        wsData.push([]);
        
        let slNo = 1;
        const headers = ['Sl. No.', 'PEN', 'Name', 'Designation', 'Office Transferred from', 'From District', 'To District', 'Protection If Any'];
        
        districts.forEach(district => {
            if (!groupedData[district]) return;
            
            wsData.push([`District: ${district.toUpperCase()}`]);
            wsData.push(headers);
            
            groupedData[district].forEach(t => {
                wsData.push([
                    slNo++,
                    t.pen,
                    t.name,
                    'JPHN Gr I',
                    t.institution,
                    t.fromDistrict,
                    t.toDistrict,
                    t.weightage === 'Yes' ? (t.weightageDetails || '') : ''
                ]);
            });
            wsData.push([]);
        });
        
        const ws = XLSX.utils.aoa_to_sheet(wsData);
        
        // Set column widths
        ws['!cols'] = [
            {wch: 8}, {wch: 12}, {wch: 25}, {wch: 15}, {wch: 35}, {wch: 15}, {wch: 15}, {wch: 20}
        ];
        
        XLSX.utils.book_append_sheet(wb, ws, 'Final Transfer List');
        XLSX.writeFile(wb, getFileName('xlsx'));
    })
    .catch(err => {
        console.error('Export error:', err);
        alert('Error exporting Excel');
    });
}

function exportPDF() {
    // Fetch ALL data from server
    fetch('/final/export-data', { headers: { 'X-Requested-With': 'XMLHttpRequest' } })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            alert('Error: ' + data.error);
            return;
        }
        
        const allTransfers = data.transfers;
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF('l', 'mm', 'a4'); // Landscape
        
        // Header
        doc.setFontSize(14);
        doc.setFont('helvetica', 'bold');
        doc.text('Government of Kerala', 148, 15, { align: 'center' });
        
        doc.setFontSize(12);
        doc.text('Department: Health Services', 148, 22, { align: 'center' });
        
        let titleText = transferType === 'regular' 
            ? `Regular Transfer for Junior Public Health Nurse Gr. I - ${transferMonth} ${transferYear}`
            : `Norms Based General Transfer for Junior Public Health Nurse Gr. I - ${transferYear}`;
        doc.text(titleText, 148, 29, { align: 'center' });
        
        doc.setFontSize(11);
        doc.text(`${listType} Transfer List`, 14, 38);
        
        // Group by district
        const groupedData = {};
        allTransfers.forEach(t => {
            if (!groupedData[t.fromDistrict]) groupedData[t.fromDistrict] = [];
            groupedData[t.fromDistrict].push(t);
        });
        
        let slNo = 1;
        let startY = 45;
        const headers = [['Sl.', 'PEN', 'Name', 'Designation', 'Office', 'From', 'To', 'Protection']];
        
        districts.forEach(district => {
            if (!groupedData[district]) return;
            
            // Check if need new page
            if (startY > 170) {
                doc.addPage();
                startY = 15;
            }
            
            doc.setFontSize(10);
            doc.setFont('helvetica', 'bold');
            doc.text(`District: ${district.toUpperCase()}`, 14, startY);
            startY += 5;
            
            const rows = groupedData[district].map(t => [
                slNo++,
                t.pen,
                t.name,
                'JPHN Gr I',
                t.institution || '',
                t.fromDistrict,
                t.toDistrict,
                t.weightage === 'Yes' ? (t.weightageDetails || '') : ''
            ]);
            
            doc.autoTable({
                head: headers,
                body: rows,
                startY: startY,
                theme: 'grid',
                styles: { fontSize: 8, cellPadding: 1 },
                headStyles: { fillColor: [200, 200, 200], textColor: [0, 0, 0], fontStyle: 'bold' },
                columnStyles: {
                    0: { cellWidth: 10 },
                    1: { cellWidth: 18 },
                    2: { cellWidth: 35 },
                    3: { cellWidth: 20 },
                    4: { cellWidth: 50 },
                    5: { cellWidth: 25 },
                    6: { cellWidth: 25 },
                    7: { cellWidth: 30 }
                }
            });
            
            startY = doc.lastAutoTable.finalY + 8;
        });
        
        doc.save(getFileName('pdf'));
    })
    .catch(err => {
        console.error('Export error:', err);
        alert('Error exporting PDF');
    });
}

function exportWord() {
    // Show file number modal first
    document.getElementById('fileNumberModal').classList.add('show');
}

function doExportWord() {
    const fileNumber = document.getElementById('fileNumberInput').value.trim();
    const orderDate = document.getElementById('orderDateInput').value.trim();
    const exportBtn = document.querySelector('#fileNumberModal .btn-primary');
    
    // Show loading state
    exportBtn.disabled = true;
    exportBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Loading all data...';
    
    // Fetch ALL data from server (not just current page)
    fetch('/final/export-data', {
        headers: { 'X-Requested-With': 'XMLHttpRequest' }
    })
    .then(response => response.json())
    .then(data => {
        document.getElementById('fileNumberModal').classList.remove('show');
        exportBtn.disabled = false;
        exportBtn.innerHTML = '<i class="fas fa-file-word"></i> Export Word';
        
        if (data.error) {
            alert('Error loading data: ' + data.error);
            return;
        }
        
        const allTransfers = data.transfers;
        console.log(`Exporting ${allTransfers.length} transfers`);
        
        let html;
        if (transferType === 'regular') {
            html = exportWordRegular(fileNumber, orderDate, allTransfers);
        } else {
            html = exportWordGeneral(fileNumber, orderDate, allTransfers);
        }
        
        const blob = new Blob(['\ufeff' + html], { type: 'application/msword' });
        saveAs(blob, getFileName('doc'));
    })
    .catch(err => {
        document.getElementById('fileNumberModal').classList.remove('show');
        exportBtn.disabled = false;
        exportBtn.innerHTML = '<i class="fas fa-file-word"></i> Export Word';
        console.error('Export error:', err);
        alert('Error exporting: ' + err.message);
    });
}

function closeFileNumberModal() {
    document.getElementById('fileNumberModal').classList.remove('show');
}

function exportWordRegular(fileNumber, orderDate, allTransfers) {
    // Sort data by transfer_to_district (South to North), then by seniority (duration desc)
    // Weightage employees come first within each destination district
    const districtOrder = {
        'Thiruvananthapuram': 1, 'Kollam': 2, 'Pathanamthitta': 3, 'Alappuzha': 4,
        'Kottayam': 5, 'Idukki': 6, 'Ernakulam': 7, 'Thrissur': 8, 'Palakkad': 9,
        'Malappuram': 10, 'Kozhikode': 11, 'Wayanad': 12, 'Kannur': 13, 'Kasaragod': 14
    };
    
    const sortedData = [...allTransfers].sort((a, b) => {
        // First by transfer_to_district (South to North)
        const distA = districtOrder[a.toDistrict] || 15;
        const distB = districtOrder[b.toDistrict] || 15;
        if (distA !== distB) return distA - distB;
        // Then weightage first
        if (a.weightage === 'Yes' && b.weightage !== 'Yes') return -1;
        if (a.weightage !== 'Yes' && b.weightage === 'Yes') return 1;
        // Then by duration desc (seniority)
        return (b.duration || 0) - (a.duration || 0);
    });
    
    // Format the order line with file number if provided
    const orderNumberText = fileNumber ? fileNumber : '__________';
    const orderDateText = orderDate ? orderDate : '__________';
    
    // Regular Transfer - Malayalam format matching desktop app exactly
    let html = `
        <html xmlns:o="urn:schemas-microsoft-com:office:office" 
              xmlns:w="urn:schemas-microsoft-com:office:word" 
              xmlns="http://www.w3.org/TR/REC-html40">
        <head>
            <meta charset="utf-8">
            <title>Regular Transfer List</title>
            <!--[if gte mso 9]>
            <xml>
                <w:WordDocument>
                    <w:View>Print</w:View>
                    <w:Zoom>100</w:Zoom>
                    <w:DoNotOptimizeForBrowser/>
                </w:WordDocument>
            </xml>
            <![endif]-->
            <style>
                @page {
                    size: A4 portrait;
                    margin: 1.5cm 1cm 1.5cm 1cm;
                    mso-page-orientation: portrait;
                }
                body { 
                    font-family: 'MANDARAM', 'Noto Sans Malayalam', Arial, sans-serif; 
                    font-size: 12pt;
                    line-height: 1.1;
                }
                .title-section {
                    text-align: center;
                    margin-bottom: 10px;
                }
                .title-text {
                    font-size: 14pt;
                    font-weight: bold;
                    text-decoration: underline;
                }
                .subject-table {
                    width: 100%;
                    border: none;
                    margin: 10px 0;
                }
                .subject-table td {
                    border: none;
                    padding: 4px 0;
                    font-size: 12pt;
                    vertical-align: top;
                }
                .subject-label {
                    width: 80px;
                    text-align: right;
                    padding-right: 8px;
                }
                .subject-text {
                    text-align: justify;
                }
                .order-section {
                    text-align: center;
                    margin: 10px 0;
                }
                .order-text {
                    font-size: 13pt;
                    font-weight: bold;
                    text-decoration: underline;
                }
                .body-text {
                    text-align: justify;
                    text-indent: 30px;
                    margin: 10px 0;
                    font-size: 12pt;
                }
                table.data-table {
                    border-collapse: collapse;
                    width: 100%;
                    margin: 10px 0;
                    page-break-inside: auto;
                    table-layout: fixed;
                    mso-table-layout-alt: fixed;
                }
                table.data-table th, table.data-table td {
                    border: 1px solid black;
                    padding: 2px 4px;
                    font-size: 9pt;
                    vertical-align: top;
                    word-wrap: break-word;
                    overflow-wrap: break-word;
                    mso-line-height-rule: exactly;
                }
                table.data-table th {
                    text-align: center;
                    font-weight: bold;
                    font-family: Arial, sans-serif;
                    font-size: 9pt;
                    background-color: #f0f0f0;
                }
                table.data-table td {
                    font-family: Arial, sans-serif;
                }
                td.center { text-align: center; }
                td.justify { text-align: justify; }
                col.col-slno { width: 28pt; }
                col.col-pen { width: 45pt; }
                col.col-name { width: 100pt; }
                col.col-inst { width: 130pt; }
                col.col-from { width: 80pt; }
                col.col-to { width: 80pt; }
                .instruction {
                    text-align: justify;
                    text-indent: 30px;
                    margin: 10px 0;
                    font-size: 12pt;
                }
                .signature-area {
                    margin-top: 25px;
                    text-indent: 220px;
                    font-size: 12pt;
                    font-weight: bold;
                }
                .receiver-section {
                    margin-top: 15px;
                    font-size: 12pt;
                }
                .receiver-title {
                    margin-bottom: 5px;
                }
                .receiver-text {
                    text-indent: 30px;
                    font-weight: bold;
                }
                .copy-section {
                    margin-top: 10px;
                    font-size: 12pt;
                }
                .copy-item {
                    margin-left: 30px;
                    margin-top: 5px;
                }
            </style>
        </head>
        <body>
            <div class="title-section">
                <span class="title-text">തിരുവനന്തപുരം, ആരോഗ്യവകുപ്പ് ഡയറക്ടറുടെ കാര്യാലയത്തിലെ</span><br>
                <span class="title-text">അഡീഷണൽ ഡയറക്ടർ (എ & റ്റി) – യുടെ നടപടിക്രമം</span>
            </div>
            
            <table class="subject-table">
                <tr>
                    <td class="subject-label">വിഷയം :</td>
                    <td class="subject-text">ആ.വ. – ആ.വ.ഡ - ജൂനിയർ പബ്ലിക് ഹെൽത്ത് നഴ്‌സ് ഗ്രേഡ് 1 തസ്തികയിലെ ജീവനക്കാർക്ക് സ്ഥലംമാറ്റം അനുവദിച്ച് ഉത്തരവ് പുറപ്പെടുവിക്കുന്നു.</td>
                </tr>
                <tr>
                    <td class="subject-label">പരാമർശം :</td>
                    <td class="subject-text">വിവിധ ജില്ലാ മെഡിക്കൽ ഓഫീസ് (ആരോഗ്യം) - ൽ നിന്നും ലഭ്യമായ ജൂനിയർ പബ്ലിക്ക് ഹെൽത്ത് നഴ്സ് ഗ്രേഡ് I ജീവനക്കാരുടെ അപേക്ഷകൾ.</td>
                </tr>
            </table>
            
            <div class="order-section">
                <span class="order-text">ഉത്തരവ് നം. ${orderNumberText}, തീയതി: ${orderDateText}</span>
            </div>
            
            <p class="body-text">വിവിധ ജില്ലാ മെഡിക്കൽ ഓഫീസ് (ആരോഗ്യം) - ൽ നിന്നും മേൽ പരാമർശ പ്രകാരം ലഭ്യമായ ജൂനിയർ പബ്ലിക്ക് ഹെൽത്ത് നഴ്സ് ഗ്രേഡ് I – ജീവനക്കാരുടെ സ്ഥലംമാറ്റത്തിനുള്ള അപേക്ഷകൾ പരിഗണിച്ച്, ചുവടെ ചേർക്കുന്ന ജീവനക്കാർക്ക് അവരുടെ പേരിന് നേരെ രേഖപ്പെടുത്തിയിട്ടുള്ള ജില്ലകളിലേക്ക് സ്ഥലം മാറ്റം നൽകി ഉത്തരവാകുന്നു.</p>
            
            <table class="data-table">
                <colgroup>
                    <col class="col-slno">
                    <col class="col-pen">
                    <col class="col-name">
                    <col class="col-inst">
                    <col class="col-from">
                    <col class="col-to">
                </colgroup>
                <tr>
                    <th>Sl. No.</th>
                    <th>PEN</th>
                    <th>Name</th>
                    <th>Present Institution</th>
                    <th>Present District</th>
                    <th>Allotted District</th>
                </tr>`;
    
    // Add all records in sorted order (by transfer_to_district, then seniority)
    sortedData.forEach((t, idx) => {
        html += `<tr>
                <td class="center">${idx + 1}</td>
                <td>${t.pen}</td>
                <td>${t.name || ''}</td>
                <td>${t.institution || ''}</td>
                <td>${(t.fromDistrict || '').toUpperCase()}</td>
                <td>${(t.toDistrict || '').toUpperCase()}</td>
            </tr>`;
    });
    
    html += `</table>
            
            <p class="instruction">ബന്ധപ്പെട്ട ജില്ലാ മെഡിക്കൽ ഓഫീസർമാർ ജീവനക്കാർക്ക് നിയമന ഉത്തരവ് നൽകേണ്ടതും നിയമന ഉത്തരവ് ലഭിച്ച ശേഷം സ്ഥാപന മേധാവികൾ ജീവനക്കാരെ വിടുതൽ ചെയ്യേണ്ടതും, ടി വിവരം യഥാസമയേ ഈ കാര്യാലയത്തിൽ റിപ്പോർട്ട് ചെയ്യേണ്ടതുമാണ്.</p>
            
            <p class="instruction">ആരോഗ്യവകുപ്പ് ഡയറക്ടറുടെ ഔദ്യോഗിക വെബ്സൈറ്റിൽ പ്രസിദ്ധീകരിച്ചിട്ടുള്ള ഈ ഉത്തരവിന്റെ പകർപ്പ് ഔദ്യോഗിക രേഖയായി ഉപയോഗിക്കാവുന്നതാണ്.</p>
            
            <br><br>
            
            <p class="signature-area">#ApprovedByName#</p>
            <p class="signature-area">#ApprovedByDesignation#</p>
            
            <div class="receiver-section">
                <p class="receiver-title">സ്വീകർത്താവ്</p>
                <p class="receiver-text">ബന്ധപ്പെട്ട ജില്ലാ മെഡിക്കൽ ഓഫീസർ (ആരോഗ്യം) മാർ</p>
            </div>
            
            <div class="copy-section">
                <p>പകർപ്പ്:</p>
                <p class="copy-item">1. ആരോഗ്യവകുപ്പ് ഡയറക്ടറുടെ ഔദ്യോഗിക വെബ്സൈറ്റ്</p>
                <p class="copy-item">2. ഫയൽ/കരുതൽ ഫയൽ</p>
            </div>
        </body>
        </html>`;
    
    return html;
}

function exportWordGeneral(fileNumber, orderDate, allTransfers) {
    // Sort data by transfer_to_district (South to North), then by seniority (duration desc)
    // Weightage employees come first within each destination district
    const districtOrder = {
        'Thiruvananthapuram': 1, 'Kollam': 2, 'Pathanamthitta': 3, 'Alappuzha': 4,
        'Kottayam': 5, 'Idukki': 6, 'Ernakulam': 7, 'Thrissur': 8, 'Palakkad': 9,
        'Malappuram': 10, 'Kozhikode': 11, 'Wayanad': 12, 'Kannur': 13, 'Kasaragod': 14
    };
    
    // Group by transfer_to_district for general transfer
    const groupedData = {};
    allTransfers.forEach(t => {
        const toDistrict = t.toDistrict;
        if (!groupedData[toDistrict]) groupedData[toDistrict] = [];
        groupedData[toDistrict].push(t);
    });
    
    // Sort within each group by weightage first, then seniority
    Object.keys(groupedData).forEach(dist => {
        groupedData[dist].sort((a, b) => {
            // Weightage first
            if (a.weightage === 'Yes' && b.weightage !== 'Yes') return -1;
            if (a.weightage !== 'Yes' && b.weightage === 'Yes') return 1;
            // Then by duration desc (seniority)
            return (b.duration || 0) - (a.duration || 0);
        });
    });
    
    // Order districts from South to North
    const sortedDistricts = Object.keys(groupedData).sort((a, b) => {
        return (districtOrder[a] || 15) - (districtOrder[b] || 15);
    });
    
    let html = `
        <html xmlns:o="urn:schemas-microsoft-com:office:office" 
              xmlns:w="urn:schemas-microsoft-com:office:word" 
              xmlns="http://www.w3.org/TR/REC-html40">
        <head>
            <meta charset="utf-8">
            <title>General Transfer List</title>
            <!--[if gte mso 9]>
            <xml>
                <w:WordDocument>
                    <w:View>Print</w:View>
                    <w:Zoom>100</w:Zoom>
                    <w:DoNotOptimizeForBrowser/>
                </w:WordDocument>
            </xml>
            <![endif]-->
            <style>
                @page {
                    size: A4 landscape;
                    margin: 1.2cm 1cm 1.2cm 1cm;
                }
                body { 
                    font-family: Arial, sans-serif; 
                    font-size: 10pt;
                    line-height: 1.3;
                }
                .header-section {
                    text-align: center;
                    margin-bottom: 15px;
                }
                .header-title {
                    font-size: 14pt;
                    font-weight: bold;
                    margin: 5px 0;
                    font-family: Arial, sans-serif;
                }
                .header-subtitle {
                    font-size: 12pt;
                    font-weight: bold;
                    margin: 5px 0;
                    font-family: Arial, sans-serif;
                }
                .header-underline {
                    font-size: 12pt;
                    font-weight: bold;
                    text-decoration: underline;
                    margin: 5px 0;
                    font-family: Arial, sans-serif;
                }
                .cadre-info {
                    font-size: 10pt;
                    font-weight: bold;
                    text-align: left;
                    margin: 10px 0;
                    font-family: Arial, sans-serif;
                }
                .district-header {
                    font-size: 11pt;
                    font-weight: bold;
                    margin: 15px 0 8px 0;
                    page-break-inside: avoid;
                    font-family: Arial, sans-serif;
                }
                table {
                    border-collapse: collapse;
                    width: 100%;
                    margin-bottom: 10px;
                    page-break-inside: auto;
                    table-layout: fixed;
                }
                tr {
                    page-break-inside: avoid;
                    page-break-after: auto;
                }
                th, td {
                    border: 1px solid black;
                    padding: 3px 5px;
                    font-size: 9pt;
                    vertical-align: top;
                    font-family: Arial, sans-serif;
                    word-wrap: break-word;
                    overflow-wrap: break-word;
                }
                th {
                    background-color: #E0E0E0;
                    font-weight: bold;
                    text-align: center;
                }
                td.center { text-align: center; }
                .col-slno { width: 4%; }
                .col-pen { width: 7%; }
                .col-name { width: 16%; }
                .col-desig { width: 9%; }
                .col-office { width: 26%; }
                .col-from { width: 12%; }
                .col-to { width: 12%; }
                .col-protection { width: 14%; }
                .signature-section {
                    margin-top: 30px;
                    text-align: right;
                    page-break-inside: avoid;
                    font-family: Arial, sans-serif;
                }
                .signature-text {
                    font-size: 10pt;
                    font-family: Arial, sans-serif;
                }
            </style>
        </head>
        <body>
            <div class="header-section">
                <p class="header-title">Government of Kerala</p>
                <p class="header-subtitle">Department: Health Services</p>
                <p class="header-underline">Norms Based General Transfer for Junior Public Health Nurse Gr. I - ${transferYear}</p>
            </div>
            <p class="cadre-info">Post/Cadre Name: Junior Public Health Nurse</p>
    `;
    
    let slNo = 1;
    
    sortedDistricts.forEach(district => {
        if (!groupedData[district]) return;
        
        html += `<p class="district-header">Allotted District: ${district.toUpperCase()}</p>`;
        html += `<table>
            <tr>
                <th class="col-slno">Sl. No.</th>
                <th class="col-pen">PEN</th>
                <th class="col-name">Name</th>
                <th class="col-desig">Designation</th>
                <th class="col-office">Office Transferred from</th>
                <th class="col-from">From District</th>
                <th class="col-to">To District</th>
                <th class="col-protection">Protection If Any</th>
            </tr>`;
        
        groupedData[district].forEach(t => {
            const protection = t.weightage === 'Yes' ? (t.weightageDetails || '') : '';
            html += `<tr>
                <td class="center">${slNo++}</td>
                <td>${t.pen}</td>
                <td>${t.name || ''}</td>
                <td>JPHN Gr I</td>
                <td>${t.institution || ''}</td>
                <td>${t.fromDistrict || ''}</td>
                <td>${t.toDistrict || ''}</td>
                <td>${protection}</td>
            </tr>`;
        });
        html += '</table>';
    });
    
    // Add signature section
    html += `
            <div class="signature-section">
                <p class="signature-text">
                    <br><br><br>
                    _________________________<br>
                    <b>Authorized Signatory</b>
                </p>
            </div>
        </body>
        </html>`;
    
    return html;
}

// Generate transfer summary
if (transferData.length > 0) {
    const summary = {};
    transferData.forEach(t => {
        const toDistrict = t.toDistrict;
        if (!summary[toDistrict]) {
            summary[toDistrict] = 0;
        }
        summary[toDistrict]++;
    });
    
    const container = document.getElementById('transfer-summary');
    if (container) {
        let html = '';
        for (const [district, count] of Object.entries(summary).sort((a, b) => b[1] - a[1])) {
            html += `
                <div class="summary-item">
                    <span class="district-name">${district}</span>
                    <span class="transfer-count">${count}</span>
                </div>
            `;
        }
        container.innerHTML = html;
    }
}

// Search/Filter table - AJAX based for full database search
let searchTimeout = null;
let isSearchActive = false;
const originalTable = document.querySelector('#finalTable tbody').innerHTML;

function filterTable() {
    const searchInput = document.getElementById('tableSearch');
    const searchTerm = searchInput.value.trim();
    const clearBtn = document.querySelector('.search-clear');
    
    clearBtn.style.display = searchTerm ? 'block' : 'none';
    
    // If search is empty or too short, restore original table
    if (!searchTerm || searchTerm.length < 2) {
        if (isSearchActive) {
            document.querySelector('#finalTable tbody').innerHTML = originalTable;
            isSearchActive = false;
        }
        document.querySelector('.record-count').textContent = 'Showing {{ transfers|length }} of {{ total_count }} confirmed transfer(s) (Page {{ page }} of {{ total_pages }})';
        return;
    }
    
    // Debounce AJAX search
    if (searchTimeout) clearTimeout(searchTimeout);
    searchTimeout = setTimeout(() => {
        performAjaxSearch(searchTerm);
    }, 300);
}

function performAjaxSearch(searchTerm) {
    const fromDistrict = '{{ from_district }}';
    const toDistrict = '{{ to_district }}';
    const tbody = document.querySelector('#finalTable tbody');
    
    // Show loading
    document.querySelector('.record-count').textContent = 'Searching...';
    
    fetch(`/final/search?q=${encodeURIComponent(searchTerm)}&from_district=${encodeURIComponent(fromDistrict)}&to_district=${encodeURIComponent(toDistrict)}`, {
        headers: { 'X-Requested-With': 'XMLHttpRequest' }
    })
        .then(response => {
            if (!response.ok) throw new Error('Search failed');
            return response.json();
        })
        .then(data => {
            if (data.error) {
                console.error('Search error:', data.error);
                document.querySelector('.record-count').textContent = 'Search failed';
                return;
            }
            isSearchActive = true;
            
            if (data.transfers.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="text-center text-muted no-data">No transfers found matching your search</td></tr>';
                document.querySelector('.record-count').textContent = 'Showing: 0 results';
                return;
            }
            
            document.querySelector('.record-count').textContent = `Showing: ${data.transfers.length} results (from all pages)`;
            
            let html = '';
            data.transfers.forEach((t, index) => {
                const weightageClass = t.weightage === 'Yes' ? 'row-weightage' : '';
                
                html += `
                    <tr data-pen="${t.pen}" class="${weightageClass}">
                        <td>${index + 1}</td>
                        <td>${t.pen}</td>
                        <td>${t.name}</td>
                        <td>${t.institution}</td>
                        <td>${t.from_district}</td>
                        <td>${t.duration}</td>
                        <td><strong class="to-district">${t.to_district}</strong></td>
                        <td>${t.weightage}</td>
                    </tr>
                `;
            });
            
            tbody.innerHTML = html;
        })
        .catch(err => {
            console.error('Search error:', err);
            document.querySelector('.record-count').textContent = 'Search error';
        });
}

function clearSearch() {
    const searchInput = document.getElementById('tableSearch');
    searchInput.value = '';
    
    if (isSearchActive) {
        document.querySelector('#finalTable tbody').innerHTML = originalTable;
        isSearchActive = false;
    }
    
    document.querySelector('.record-count').textContent = 'Showing {{ transfers|length }} of {{ total_count }} confirmed transfer(s) (Page {{ page }} of {{ total_pages }})';
    searchInput.focus();
}

function toggleDropdown(id) {
    const dropdown = document.getElementById(id);
    dropdown.classList.toggle('show');
}

// Close dropdown when clicking outside
window.onclick = function(e) {
    if (!e.target.matches('.dropdown-toggle') && !e.target.closest('.dropdown-toggle')) {
        document.querySelectorAll('.dropdown-menu').forEach(d => d.classList.remove('show'));
    }
}
</script>

<style>
.search-group {
    min-width: 250px;
}
.search-box-inline {
    display: flex;
    align-items: center;
    background: var(--bg-card);
    border: 1px solid var(--border-color);
    border-radius: 6px;
    padding: 0.4rem 0.6rem;
}
.search-box-inline i.fa-search {
    color: var(--text-muted);
    margin-right: 0.5rem;
}
.search-box-inline input {
    flex: 1;
    border: none;
    background: transparent;
    font-size: 0.85rem;
    color: var(--text-primary);
    outline: none;
    min-width: 150px;
}
.search-box-inline input::placeholder {
    color: var(--text-muted);
}
.search-box-inline .search-clear {
    background: none;
    border: none;
    color: var(--text-muted);
    cursor: pointer;
    padding: 0.2rem;
    display: none;
}
.search-box-inline .search-clear:hover {
    color: var(--danger-color);
}

/* Pagination Styles */
.table-footer {
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: 1rem;
    padding: 1rem;
    background: var(--bg-secondary);
    border-radius: 0 0 8px 8px;
}

.pagination {
    display: flex;
    gap: 0.3rem;
    align-items: center;
}

.page-btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    min-width: 36px;
    height: 36px;
    padding: 0 0.5rem;
    border: 1px solid var(--border-color);
    border-radius: 6px;
    background: var(--bg-card);
    color: var(--text-primary);
    text-decoration: none;
    font-weight: 500;
    transition: all 0.2s;
}

.page-btn:hover {
    background: var(--primary-color);
    color: white;
    border-color: var(--primary-color);
}

.page-btn.active {
    background: var(--primary-color);
    color: white;
    border-color: var(--primary-color);
}

/* Excluded Modal Styles */
.excluded-modal-overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.6);
    z-index: 1000;
    justify-content: center;
    align-items: center;
}
.excluded-modal-overlay.show {
    display: flex;
}
.excluded-modal {
    background: var(--bg-primary);
    border-radius: 12px;
    width: 95%;
    max-width: 1200px;
    max-height: 90vh;
    display: flex;
    flex-direction: column;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
}
.excluded-modal-header {
    padding: 1rem 1.5rem;
    border-bottom: 1px solid var(--border-color);
    display: flex;
    justify-content: space-between;
    align-items: center;
}
.excluded-modal-header h3 {
    margin: 0;
    color: var(--text-primary);
}
.excluded-modal-header .close-btn {
    background: none;
    border: none;
    font-size: 1.5rem;
    cursor: pointer;
    color: var(--text-muted);
}
.excluded-modal-header .close-btn:hover {
    color: var(--danger-color);
}
.excluded-modal-body {
    padding: 1rem 1.5rem;
    overflow-y: auto;
    flex: 1;
}
.excluded-modal-footer {
    padding: 1rem 1.5rem;
    border-top: 1px solid var(--border-color);
    display: flex;
    justify-content: space-between;
    align-items: center;
}
.excluded-table {
    width: 100%;
    border-collapse: collapse;
}
.excluded-table th, .excluded-table td {
    padding: 8px 10px;
    text-align: left;
    border: 1px solid var(--border-color);
}
.excluded-table th {
    background: var(--bg-secondary);
    font-weight: 600;
}
.excluded-table tr:hover {
    background: var(--bg-hover);
}

/* File Number Modal Styles */
.file-number-modal-overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.6);
    z-index: 1000;
    justify-content: center;
    align-items: center;
}
.file-number-modal-overlay.show {
    display: flex;
}
.file-number-modal {
    background: var(--bg-primary);
    border-radius: 12px;
    width: 90%;
    max-width: 500px;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
}
.file-number-modal-header {
    padding: 1rem 1.5rem;
    border-bottom: 1px solid var(--border-color);
    display: flex;
    justify-content: space-between;
    align-items: center;
}
.file-number-modal-header h3 {
    margin: 0;
    color: var(--text-primary);
}
.file-number-modal-header .close-btn {
    background: none;
    border: none;
    font-size: 1.5rem;
    cursor: pointer;
    color: var(--text-muted);
}
.file-number-modal-header .close-btn:hover {
    color: var(--danger-color);
}
.file-number-modal-body {
    padding: 1.5rem;
}
.file-number-modal-body .form-group {
    margin-bottom: 1rem;
}
.file-number-modal-body label {
    display: block;
    margin-bottom: 0.5rem;
    font-weight: 600;
    color: var(--text-primary);
}
.file-number-modal-body input {
    width: 100%;
    padding: 0.6rem 0.8rem;
    border: 1px solid var(--border-color);
    border-radius: 6px;
    font-size: 1rem;
    background: var(--bg-secondary);
    color: var(--text-primary);
}
.file-number-modal-body input:focus {
    outline: none;
    border-color: var(--primary-color);
    box-shadow: 0 0 0 3px rgba(var(--primary-rgb), 0.1);
}
.file-number-modal-body .hint {
    font-size: 0.85rem;
    color: var(--text-muted);
    margin-top: 0.3rem;
}
.file-number-modal-footer {
    padding: 1rem 1.5rem;
    border-top: 1px solid var(--border-color);
    display: flex;
    justify-content: flex-end;
    gap: 0.8rem;
}
</style>

<!-- File Number Input Modal -->
<div class="file-number-modal-overlay" id="fileNumberModal">
    <div class="file-number-modal">
        <div class="file-number-modal-header">
            <h3><i class="fas fa-file-word"></i> Word Export - Order Details</h3>
            <button class="close-btn" onclick="closeFileNumberModal()">&times;</button>
        </div>
        <div class="file-number-modal-body">
            <div class="form-group">
                <label for="fileNumberInput">ഉത്തരവ് നം. (Order Number)</label>
                <input type="text" id="fileNumberInput" placeholder="e.g., A3-12345/2025/DHS">
                <p class="hint">Enter the file/order number to include in the document</p>
            </div>
            <div class="form-group">
                <label for="orderDateInput">തീയതി (Date)</label>
                <input type="text" id="orderDateInput" placeholder="e.g., 15-01-2025">
                <p class="hint">Enter the order date</p>
            </div>
        </div>
        <div class="file-number-modal-footer">
            <button class="btn btn-secondary" onclick="closeFileNumberModal()">
                <i class="fas fa-times"></i> Cancel
            </button>
            <button class="btn btn-primary" onclick="doExportWord()">
                <i class="fas fa-file-word"></i> Export
            </button>
        </div>
    </div>
</div>

<!-- Excluded Employees Modal -->
<div class="excluded-modal-overlay" id="excludedModal">
    <div class="excluded-modal">
        <div class="excluded-modal-header">
            <h3><i class="fas fa-user-minus"></i> Applied but Not Included in Final List (<span id="excludedCount">0</span>)</h3>
            <button class="close-btn" onclick="closeExcludedModal()">&times;</button>
        </div>
        <div class="excluded-modal-body">
            <table class="excluded-table" id="excludedTable">
                <thead>
                    <tr>
                        <th>Sl No</th>
                        <th>PEN</th>
                        <th>Name</th>
                        <th>Institution</th>
                        <th>District</th>
                        <th>Duration</th>
                        <th>Weightage</th>
                        <th>Pref 1</th>
                        <th>Pref 2</th>
                        <th>Pref 3</th>
                    </tr>
                </thead>
                <tbody id="excludedTableBody">
                </tbody>
            </table>
        </div>
        <div class="excluded-modal-footer">
            <span id="excludedInfo"></span>
            <button class="btn btn-success" onclick="exportExcludedExcel()">
                <i class="fas fa-file-excel"></i> Export to Excel
            </button>
        </div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script>
let excludedEmployees = [];

function showExcluded() {
    fetch('/final/excluded')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                excludedEmployees = data.employees;
                document.getElementById('excludedCount').textContent = data.count;
                document.getElementById('excludedInfo').textContent = `Total: ${data.count} employees applied but not included`;
                
                const tbody = document.getElementById('excludedTableBody');
                tbody.innerHTML = '';
                
                data.employees.forEach((emp, index) => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${index + 1}</td>
                        <td>${emp.pen}</td>
                        <td>${emp.name}</td>
                        <td>${emp.institution}</td>
                        <td>${emp.district}</td>
                        <td>${emp.duration}</td>
                        <td>${emp.weightage}</td>
                        <td>${emp.pref1}</td>
                        <td>${emp.pref2}</td>
                        <td>${emp.pref3}</td>
                    `;
                    tbody.appendChild(row);
                });
                
                document.getElementById('excludedModal').classList.add('show');
            } else {
                alert('Error loading excluded employees: ' + data.error);
            }
        })
        .catch(error => {
            alert('Error: ' + error);
        });
}

function closeExcludedModal() {
    document.getElementById('excludedModal').classList.remove('show');
}

function exportExcludedExcel() {
    if (excludedEmployees.length === 0) {
        alert('No data to export');
        return;
    }
    
    const data = excludedEmployees.map((emp, index) => ({
        'Sl No': index + 1,
        'PEN': emp.pen,
        'Name': emp.name,
        'Institution': emp.institution,
        'District': emp.district,
        'Duration': emp.duration,
        'Weightage': emp.weightage,
        'Preference 1': emp.pref1,
        'Preference 2': emp.pref2,
        'Preference 3': emp.pref3
    }));
    
    const ws = XLSX.utils.json_to_sheet(data);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, 'Not Included in Final');
    XLSX.writeFile(wb, 'Not_Included_in_Final_List.xlsx');
}

// Close modal on clicking outside
document.getElementById('excludedModal').addEventListener('click', function(e) {
    if (e.target === this) {
        closeExcludedModal();
    }
});
</script>
{% endblock %}
