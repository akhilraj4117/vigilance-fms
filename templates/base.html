<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}JPHN Transfer Management{% endblock %}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Export libraries - works without Python packages -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    {% block extra_css %}{% endblock %}
</head>
<body>
    {% if current_user.is_authenticated %}
    <nav class="navbar">
        <div class="nav-brand">
            <i class="fas fa-exchange-alt"></i>
            <span>JPHN Transfer Management</span>
        </div>
        <div class="nav-session">
            {% if session.get('transfer_type') %}
            <span class="session-badge">
                {{ session.get('transfer_type', '').title() }} Transfer - 
                {% if session.get('month') %}{{ session.get('month') }} {% endif %}{{ session.get('year') }}
            </span>
            <a href="{{ url_for('select_transfer') }}" class="nav-link"><i class="fas fa-sync"></i> Change</a>
            {% endif %}
        </div>
        <div class="nav-links">
            <a href="{{ url_for('dashboard') }}" class="nav-link {% if request.endpoint == 'dashboard' %}active{% endif %}">
                <i class="fas fa-home"></i> Dashboard
            </a>
            <a href="{{ url_for('vacancy_list') }}" class="nav-link {% if request.endpoint == 'vacancy_list' %}active{% endif %}">
                <i class="fas fa-building"></i> Vacancy
            </a>
            <a href="{{ url_for('application_list') }}" class="nav-link {% if 'application' in request.endpoint %}active{% endif %}">
                <i class="fas fa-file-alt"></i> Applications
            </a>
            <a href="{{ url_for('applied_employees') }}" class="nav-link {% if request.endpoint == 'applied_employees' %}active{% endif %}">
                <i class="fas fa-check-circle"></i> Applied
            </a>
            {% if autofill_ran %}
            <a href="{{ url_for('draft_list') }}" class="nav-link {% if 'draft' in request.endpoint %}active{% endif %}">
                <i class="fas fa-clipboard-list"></i> Draft List
            </a>
            {% else %}
            <span class="nav-link disabled" title="Run Auto-fill first from Applied page">
                <i class="fas fa-clipboard-list"></i> Draft List <i class="fas fa-lock" style="font-size: 0.7rem; margin-left: 3px;"></i>
            </span>
            {% endif %}
            {% if final_exists %}
            <a href="{{ url_for('final_list') }}" class="nav-link {% if 'final' in request.endpoint %}active{% endif %}">
                <i class="fas fa-check-double"></i> Final List
            </a>
            {% else %}
            <span class="nav-link disabled" title="Confirm Draft List first">
                <i class="fas fa-check-double"></i> Final List <i class="fas fa-lock" style="font-size: 0.7rem; margin-left: 3px;"></i>
            </span>
            {% endif %}
            <a href="{{ url_for('cadre_list') }}" class="nav-link {% if 'cadre' in request.endpoint %}active{% endif %}">
                <i class="fas fa-users"></i> Cadre List
            </a>
            <button id="theme-toggle" class="theme-btn" title="Toggle Theme">
                <i class="fas fa-moon"></i>
            </button>
            <a href="{{ url_for('logout') }}" class="nav-link logout-btn">
                <i class="fas fa-sign-out-alt"></i> Logout
            </a>
        </div>
    </nav>
    {% endif %}

    <main class="main-content">
        <!-- Flash messages -->
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                <div class="flash-messages">
                    {% for category, message in messages %}
                        <div class="flash-message flash-{{ category }}">
                            <i class="fas {% if category == 'success' %}fa-check-circle{% elif category == 'error' %}fa-exclamation-circle{% elif category == 'warning' %}fa-exclamation-triangle{% else %}fa-info-circle{% endif %}"></i>
                            {{ message }}
                            <button class="flash-close" onclick="this.parentElement.remove()">Ã—</button>
                        </div>
                    {% endfor %}
                </div>
            {% endif %}
        {% endwith %}

        {% block content %}{% endblock %}
    </main>

    <footer class="footer">
        <p>Department of Health Services, Kerala | JPHN Transfer Management System</p>
    </footer>

    <script src="{{ url_for('static', filename='js/script.js') }}"></script>
    <script>
    // Sortable Table Functionality - Optimized for performance
    function sortTable(table, columnIndex, dataType) {
        const tbody = table.querySelector('tbody');
        const rows = Array.from(tbody.querySelectorAll('tr:not(.no-data-row)'));
        const header = table.querySelectorAll('th')[columnIndex];
        
        // Determine current sort direction
        const isAscending = header.classList.contains('sort-asc');
        
        // Remove sort classes from all headers
        table.querySelectorAll('th').forEach(th => {
            th.classList.remove('sort-asc', 'sort-desc');
        });
        
        // Pre-compute sort values for performance (avoid parsing during comparison)
        const rowData = rows.map(row => {
            let val = row.cells[columnIndex]?.textContent.trim() || '';
            let sortVal;
            
            if (dataType === 'number') {
                sortVal = parseFloat(val.replace(/[^\d.-]/g, '')) || 0;
            } else if (dataType === 'duration') {
                sortVal = parseDuration(val);
            } else if (dataType === 'date') {
                sortVal = parseDate(val);
            } else {
                sortVal = val.toLowerCase();
            }
            
            return { row, sortVal };
        });
        
        // Sort using pre-computed values
        rowData.sort((a, b) => {
            if (a.sortVal < b.sortVal) return isAscending ? 1 : -1;
            if (a.sortVal > b.sortVal) return isAscending ? -1 : 1;
            return 0;
        });
        
        // Update header class
        header.classList.add(isAscending ? 'sort-desc' : 'sort-asc');
        
        // Use document fragment for batch DOM update (faster)
        const fragment = document.createDocumentFragment();
        rowData.forEach((item, index) => {
            const firstCell = item.row.cells[0];
            if (firstCell && !isNaN(parseInt(firstCell.textContent))) {
                firstCell.textContent = index + 1;
            }
            fragment.appendChild(item.row);
        });
        tbody.appendChild(fragment);
    }
    
    function parseDuration(str) {
        // Parse "5Y 3M 10D" format
        let total = 0;
        const years = str.match(/(\d+)Y/);
        const months = str.match(/(\d+)M/);
        const days = str.match(/(\d+)D/);
        if (years) total += parseInt(years[1]) * 365;
        if (months) total += parseInt(months[1]) * 30;
        if (days) total += parseInt(days[1]);
        return total;
    }
    
    function parseDate(str) {
        // Parse "DD-MM-YYYY" format
        if (!str || str === '-') return 0;
        const parts = str.split('-');
        if (parts.length === 3) {
            return new Date(parts[2], parts[1] - 1, parts[0]).getTime();
        }
        return 0;
    }
    
    // Initialize sortable tables on page load
    document.addEventListener('DOMContentLoaded', function() {
        document.querySelectorAll('.sortable').forEach(th => {
            th.style.cursor = 'pointer';
            th.title = 'Click to sort';
        });
    });
    </script>
    {% block extra_js %}{% endblock %}
</body>
</html>
