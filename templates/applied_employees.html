{% extends "base.html" %}
{% block title %}Applied Employees - JPHN Transfer{% endblock %}

{% block content %}
<div class="page-container">
    <div class="page-header">
        <h1><i class="fas fa-check-circle"></i> Applied Employees</h1>
        <div class="header-actions">
            <button type="button" class="btn btn-success" onclick="openAutoFillModal()">
                <i class="fas fa-magic"></i> Auto-fill Vacancies
            </button>
            <a href="{{ url_for('export_applied_excel') }}" class="btn btn-secondary">
                <i class="fas fa-file-excel"></i> Export Excel
            </a>
            <form method="POST" action="{{ url_for('clear_applied_list') }}" style="display:inline" 
                  onsubmit="return confirm('Clear ALL applied employees? This will remove all applications and preferences. This cannot be undone!')">>
                <button type="submit" class="btn btn-danger">
                    <i class="fas fa-trash"></i> Clear All
                </button>
            </form>
        </div>
    </div>
    
    <div class="filter-section">
        <form method="GET" class="filter-form">
            <div class="form-group">
                <label for="district">Filter by Current District</label>
                <select name="district" id="district" class="form-control" onchange="this.form.submit()">
                    <option value="">All Districts</option>
                    {% for d in districts %}
                    <option value="{{ d }}" {% if d == district_filter %}selected{% endif %}>{{ d }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="form-group">
                <label for="pref_district">Filter by Preference 1</label>
                <select name="pref_district" id="pref_district" class="form-control" onchange="this.form.submit()">
                    <option value="">All Preferences</option>
                    {% for d in districts %}
                    <option value="{{ d }}" {% if d == pref_district %}selected{% endif %}>{{ d }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="form-group search-group">
                <label for="tableSearch">Search</label>
                <div class="search-box-inline">
                    <i class="fas fa-search"></i>
                    <input type="text" id="tableSearch" class="form-control" placeholder="Search by Name or PEN..." onkeyup="filterTable()">
                    <button type="button" class="search-clear" onclick="clearSearch()" title="Clear">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
            {% if district_filter or pref_district %}
            <a href="{{ url_for('applied_employees') }}" class="btn btn-secondary">
                <i class="fas fa-times"></i> Clear Filters
            </a>
            {% endif %}
        </form>
    </div>
    
    <div class="table-container">
        <table class="data-table applied-table" id="appliedTable">
            <thead>
                <tr>
                    <th>Sl No</th>
                    <th class="sortable" onclick="sortTable(document.getElementById('appliedTable'), 1, 'number')">PEN</th>
                    <th class="sortable" onclick="sortTable(document.getElementById('appliedTable'), 2, 'text')">Name</th>
                    <th class="sortable" onclick="sortTable(document.getElementById('appliedTable'), 3, 'text')">Institution</th>
                    <th class="sortable" onclick="sortTable(document.getElementById('appliedTable'), 4, 'text')">Current District</th>
                    <th class="sortable" onclick="sortTable(document.getElementById('appliedTable'), 5, 'duration')">Duration</th>
                    <th class="sortable" onclick="sortTable(document.getElementById('appliedTable'), 6, 'text')">Weightage</th>
                    <th class="sortable" onclick="sortTable(document.getElementById('appliedTable'), 7, 'text')">Reason</th>
                    <th class="sortable" onclick="sortTable(document.getElementById('appliedTable'), 8, 'text')">Pref 1</th>
                    <th class="sortable" onclick="sortTable(document.getElementById('appliedTable'), 9, 'text')">Receipt</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for emp in employees %}
                <tr class="{% if emp[10] == 'Yes' %}row-special{% elif emp[6] == 'Yes' %}row-weightage{% endif %}" {% if emp[10] == 'Yes' %}title="Special Priority"{% endif %}>
                    <td>{{ loop.index }}</td>
                    <td>{{ emp[0] }}</td>
                    <td>{{ emp[1] }}</td>
                    <td>{{ emp[2] }}</td>
                    <td>{{ emp[3] }}</td>
                    <td>{{ format_duration(emp[4]) }}</td>
                    <td>
                        {% if emp[6] == 'Yes' %}
                        <span class="badge badge-warning" title="{{ emp[7] or '' }}">Yes</span>
                        {% else %}
                        <span class="badge badge-secondary">No</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if emp[6] == 'Yes' %}
                        <span title="{{ emp[7] or '' }}">{{ emp[7] or '-' }}</span>
                        {% else %}
                        <span class="badge badge-secondary">NA</span>
                        {% endif %}
                    </td>
                    <td class="pref-cell">{{ emp[11] or '-' }}</td>
                    <td>{{ emp[8] or '-' }}</td>
                    <td class="action-cell">
                        <button type="button" class="btn btn-sm btn-info" 
                                onclick="showDetails('{{ emp[0] }}', '{{ emp[1] }}', '{{ emp[11] }}', '{{ emp[12] }}', '{{ emp[13] }}', '{{ emp[14] }}', '{{ emp[15] }}', '{{ emp[16] }}', '{{ emp[17] }}', '{{ emp[18] }}')"
                                title="View All Preferences">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button type="button" class="btn btn-sm btn-warning" 
                                onclick="openEditModal('{{ emp[0] }}')"
                                title="Edit Application">
                            <i class="fas fa-edit"></i>
                        </button>
                        <form method="POST" action="{{ url_for('remove_from_applied', pen=emp[0]) }}" 
                              style="display:inline" onsubmit="return confirm('Remove this employee from applied list?')">
                            <button type="submit" class="btn btn-sm btn-danger" title="Remove">
                                <i class="fas fa-times"></i>
                            </button>
                        </form>
                    </td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="11" class="no-data">
                        <i class="fas fa-inbox"></i>
                        <p>No applied employees found</p>
                        <a href="{{ url_for('application_list') }}" class="btn btn-primary">Mark Applications</a>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    
    <div class="table-footer">
        <span class="record-count">Total: {{ employees|length }} employee(s)</span>
    </div>
</div>

<!-- Details Modal -->
<div id="detailsModal" class="modal">
    <div class="modal-content">
        <span class="modal-close" onclick="closeModal()">&times;</span>
        <h2><i class="fas fa-list-ol"></i> All Preferences</h2>
        <div id="modalBody"></div>
    </div>
</div>

<!-- Auto-fill Modal -->
<div id="autoFillModal" class="modal">
    <div class="modal-content modal-lg">
        <span class="modal-close" onclick="closeAutoFillModal()">&times;</span>
        <h2><i class="fas fa-magic"></i> Auto-fill Vacancies</h2>
        <form method="POST" action="{{ url_for('auto_fill_vacancies') }}">
            <div class="auto-fill-info">
                <p><strong>This will automatically assign transfers based on:</strong></p>
                <div class="priority-list">
                    <div class="priority-item priority-special">
                        <span class="priority-badge">PRIORITY 0</span>
                        <span class="priority-text">Employees with <strong>SPECIAL PRIORITY</strong> - Processed FIRST, get preferences in order</span>
                    </div>
                    <div class="priority-item priority-weightage">
                        <span class="priority-badge">PRIORITY 1</span>
                        <span class="priority-text">Employees with <strong>WEIGHTAGE</strong> - Get preferences in order if vacancy available</span>
                    </div>
                    <div class="priority-item priority-normal">
                        <span class="priority-badge">PRIORITY 2</span>
                        <span class="priority-text">Employees <strong>WITHOUT weightage</strong> - Junior employees first (least duration)</span>
                    </div>
                </div>
                <div class="cascade-info">
                    <i class="fas fa-sync-alt"></i>
                    <span><strong>CASCADING VACANCIES:</strong> When an employee transfers out, their old district gets a NEW vacancy that can also be filled!</span>
                </div>
                <p class="note"><i class="fas fa-info-circle"></i> Employees already in Draft List will be skipped. Results will appear in Draft List.</p>
            </div>
            
            <div class="form-group checkbox-group">
                <label>
                    <input type="checkbox" name="enable_against">
                    <span>Enable 'Against' Transfers (Displace senior employees if no vacancy available)</span>
                </label>
                <p class="help-text">If enabled: When an applicant cannot get ANY of their 8 preferences, the senior-most employee in their Pref 1 district will be displaced.</p>
            </div>
            
            <div class="modal-actions">
                <button type="button" class="btn btn-secondary" onclick="closeAutoFillModal()">Cancel</button>
                <button type="submit" class="btn btn-success btn-lg">
                    <i class="fas fa-rocket"></i> Start Auto-fill
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Edit Modal -->
<div id="editModal" class="modal">
    <div class="modal-content modal-lg">
        <span class="modal-close" onclick="closeEditModal()">&times;</span>
        <h2><i class="fas fa-edit"></i> Edit Application</h2>
        <form method="POST" id="editForm" action="">
            <div class="selected-employee-edit" id="editSelectedEmployee"></div>
            
            <div class="form-section">
                <div class="form-row">
                    <div class="form-group">
                        <label for="edit_receipt_numbers"><i class="fas fa-receipt"></i> Receipt Number</label>
                        <input type="text" name="receipt_numbers" id="edit_receipt_numbers" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="edit_applied_date"><i class="fas fa-calendar"></i> Applied Date</label>
                        <input type="text" name="applied_date" id="edit_applied_date" class="form-control" placeholder="DD-MM-YYYY">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group checkbox-group">
                        <label>
                            <input type="checkbox" name="special_priority" id="edit_special_priority">
                            <span>Special Priority</span>
                        </label>
                    </div>
                    <div class="form-group checkbox-group">
                        <label>
                            <input type="checkbox" name="has_weightage" id="edit_has_weightage" onchange="toggleEditWeightage()">
                            <span>Has Weightage</span>
                        </label>
                    </div>
                </div>
                
                <div class="weightage-fields" id="editWeightageFields" style="display:none;">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="edit_weightage_details">Weightage Reason</label>
                            <input type="text" name="weightage_details" id="edit_weightage_details" class="form-control">
                        </div>
                        <div class="form-group">
                            <label for="edit_weightage_priority">Priority Level</label>
                            <select name="weightage_priority" id="edit_weightage_priority" class="form-control">
                                <option value="1">1</option>
                                <option value="2">2</option>
                                <option value="3">3</option>
                                <option value="4">4</option>
                                <option value="5">5</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="form-section">
                <h4><i class="fas fa-list-ol"></i> District Preferences (1-8)</h4>
                <div class="preferences-grid">
                    <div class="form-group">
                        <label>Pref 1</label>
                        <select name="pref1" id="edit_pref1" class="form-control edit-pref-select">
                            <option value="">--</option>
                            {% for d in districts %}
                            <option value="{{ d }}">{{ d }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Pref 2</label>
                        <select name="pref2" id="edit_pref2" class="form-control edit-pref-select">
                            <option value="">--</option>
                            {% for d in districts %}
                            <option value="{{ d }}">{{ d }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Pref 3</label>
                        <select name="pref3" id="edit_pref3" class="form-control edit-pref-select">
                            <option value="">--</option>
                            {% for d in districts %}
                            <option value="{{ d }}">{{ d }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Pref 4</label>
                        <select name="pref4" id="edit_pref4" class="form-control edit-pref-select">
                            <option value="">--</option>
                            {% for d in districts %}
                            <option value="{{ d }}">{{ d }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Pref 5</label>
                        <select name="pref5" id="edit_pref5" class="form-control edit-pref-select">
                            <option value="">--</option>
                            {% for d in districts %}
                            <option value="{{ d }}">{{ d }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Pref 6</label>
                        <select name="pref6" id="edit_pref6" class="form-control edit-pref-select">
                            <option value="">--</option>
                            {% for d in districts %}
                            <option value="{{ d }}">{{ d }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Pref 7</label>
                        <select name="pref7" id="edit_pref7" class="form-control edit-pref-select">
                            <option value="">--</option>
                            {% for d in districts %}
                            <option value="{{ d }}">{{ d }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Pref 8</label>
                        <select name="pref8" id="edit_pref8" class="form-control edit-pref-select">
                            <option value="">--</option>
                            {% for d in districts %}
                            <option value="{{ d }}">{{ d }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
            </div>
            
            <div class="modal-actions">
                <button type="button" class="btn btn-secondary" onclick="closeEditModal()">Cancel</button>
                <button type="submit" class="btn btn-success">
                    <i class="fas fa-save"></i> Save Changes
                </button>
            </div>
        </form>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
function showDetails(pen, name, p1, p2, p3, p4, p5, p6, p7, p8) {
    const prefs = [p1, p2, p3, p4, p5, p6, p7, p8].filter(p => p && p !== 'None');
    let html = `<h3>${name} (${pen})</h3><div class="pref-list">`;
    prefs.forEach((p, i) => {
        html += `<div class="pref-item"><span class="pref-num">${i+1}</span><span class="pref-value">${p}</span></div>`;
    });
    if (prefs.length === 0) {
        html += '<p>No preferences set</p>';
    }
    html += '</div>';
    document.getElementById('modalBody').innerHTML = html;
    document.getElementById('detailsModal').style.display = 'flex';
}

function closeModal() {
    document.getElementById('detailsModal').style.display = 'none';
}

// Close modal on outside click
window.onclick = function(e) {
    if (e.target.classList.contains('modal')) {
        e.target.style.display = 'none';
    }
}

function openAutoFillModal() {
    document.getElementById('autoFillModal').style.display = 'flex';
}

function closeAutoFillModal() {
    document.getElementById('autoFillModal').style.display = 'none';
}

// Edit Modal Functions
function openEditModal(pen) {
    fetch(`/applied/edit/${pen}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const emp = data.data;
                
                // Set form action
                document.getElementById('editForm').action = `/applied/edit/${pen}`;
                
                // Set employee info
                document.getElementById('editSelectedEmployee').innerHTML = `
                    <strong>${emp.name}</strong> (PEN: ${emp.pen})<br>
                    <small>${emp.institution} | ${emp.district}</small>
                `;
                
                // Set form values
                document.getElementById('edit_receipt_numbers').value = emp.receipt_numbers;
                document.getElementById('edit_applied_date').value = emp.applied_date;
                document.getElementById('edit_special_priority').checked = emp.special_priority === 'Yes';
                document.getElementById('edit_has_weightage').checked = emp.weightage === 'Yes';
                document.getElementById('edit_weightage_details').value = emp.weightage_details;
                document.getElementById('edit_weightage_priority').value = emp.weightage_priority;
                
                // Show/hide weightage fields
                document.getElementById('editWeightageFields').style.display = emp.weightage === 'Yes' ? 'block' : 'none';
                
                // Set preferences
                for (let i = 1; i <= 8; i++) {
                    document.getElementById(`edit_pref${i}`).value = emp[`pref${i}`] || '';
                }
                
                // Show modal
                document.getElementById('editModal').style.display = 'flex';
            } else {
                alert('Error loading employee data: ' + data.error);
            }
        })
        .catch(error => {
            alert('Error: ' + error);
        });
}

function closeEditModal() {
    document.getElementById('editModal').style.display = 'none';
}

function toggleEditWeightage() {
    const checked = document.getElementById('edit_has_weightage').checked;
    document.getElementById('editWeightageFields').style.display = checked ? 'block' : 'none';
}

// Search/Filter table
function filterTable() {
    const searchInput = document.getElementById('tableSearch');
    const searchTerm = searchInput.value.toLowerCase().trim();
    const clearBtn = document.querySelector('.search-clear');
    const table = document.getElementById('appliedTable');
    const rows = table.querySelectorAll('tbody tr');
    
    clearBtn.style.display = searchTerm ? 'block' : 'none';
    
    let visibleCount = 0;
    
    rows.forEach(row => {
        if (row.querySelector('.no-data')) return;
        
        const pen = (row.cells[1]?.textContent || '').toLowerCase();
        const name = (row.cells[2]?.textContent || '').toLowerCase();
        const institution = (row.cells[3]?.textContent || '').toLowerCase();
        
        if (pen.includes(searchTerm) || name.includes(searchTerm) || institution.includes(searchTerm)) {
            row.style.display = '';
            visibleCount++;
        } else {
            row.style.display = 'none';
        }
    });
    
    // Update record count
    const countEl = document.querySelector('.record-count');
    if (countEl) {
        countEl.textContent = `Showing: ${visibleCount} of {{ employees|length }} employee(s)`;
    }
}

function clearSearch() {
    const searchInput = document.getElementById('tableSearch');
    searchInput.value = '';
    filterTable();
    searchInput.focus();
    document.querySelector('.record-count').textContent = 'Total: {{ employees|length }} employee(s)';
}
</script>

<style>
.search-group {
    min-width: 250px;
}
.search-box-inline {
    display: flex;
    align-items: center;
    background: var(--bg-card);
    border: 1px solid var(--border-color);
    border-radius: 6px;
    padding: 0.4rem 0.6rem;
}
.search-box-inline i.fa-search {
    color: var(--text-muted);
    margin-right: 0.5rem;
}
.search-box-inline input {
    flex: 1;
    border: none;
    background: transparent;
    font-size: 0.85rem;
    color: var(--text-primary);
    outline: none;
    min-width: 150px;
}
.search-box-inline input::placeholder {
    color: var(--text-muted);
}
.search-box-inline .search-clear {
    background: none;
    border: none;
    color: var(--text-muted);
    cursor: pointer;
    padding: 0.2rem;
    display: none;
}
.search-box-inline .search-clear:hover {
    color: var(--danger-color);
}

/* Edit Modal Styles */
.selected-employee-edit {
    background: linear-gradient(135deg, var(--primary-light), var(--primary-color));
    color: white;
    padding: 0.75rem 1rem;
    border-radius: var(--border-radius);
    margin-bottom: 1rem;
}
.form-section {
    margin-bottom: 1rem;
    padding-bottom: 1rem;
    border-bottom: 1px solid var(--border-light);
}
.form-section:last-of-type {
    border-bottom: none;
}
.form-section h4 {
    margin: 0 0 0.75rem 0;
    font-size: 0.9rem;
    color: var(--text-secondary);
}
.form-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1rem;
}
.preferences-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 0.5rem;
}
.preferences-grid .form-group {
    margin-bottom: 0;
}
.preferences-grid label {
    font-size: 0.75rem;
}
.preferences-grid .form-control {
    padding: 0.35rem;
    font-size: 0.8rem;
}
.weightage-fields {
    background: var(--bg-hover);
    padding: 0.75rem;
    border-radius: var(--border-radius);
    margin-top: 0.5rem;
}
.modal-actions {
    display: flex;
    gap: 0.5rem;
    justify-content: flex-end;
    margin-top: 1rem;
    padding-top: 1rem;
    border-top: 1px solid var(--border-light);
}
</style>
{% endblock %}
