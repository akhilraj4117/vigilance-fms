{% extends "base.html" %}
{% block title %}Vacancy Management - JPHN Transfer{% endblock %}

{% block content %}
<div class="page-container">
    <div class="page-header">
        <h1><i class="fas fa-building"></i> Vacancy Management</h1>
    </div>
    
    <form method="POST" action="{{ url_for('save_vacancy') }}" class="vacancy-form">
        <div class="vacancy-table-container">
            <table class="data-table vacancy-table" id="vacancyTable">
                <thead>
                    <tr>
                        <th>Sl No</th>
                        <th class="sortable" onclick="sortTable(document.getElementById('vacancyTable'), 1, 'text')">District</th>
                        <th class="sortable" onclick="sortTable(document.getElementById('vacancyTable'), 2, 'number')">Total Strength</th>
                        <th class="sortable" onclick="sortTable(document.getElementById('vacancyTable'), 3, 'number')">Vacancy Reported</th>
                        <th class="sortable" onclick="sortTable(document.getElementById('vacancyTable'), 4, 'number')">Applied From</th>
                        {% if autofill_ran %}
                        <th class="sortable" onclick="sortTable(document.getElementById('vacancyTable'), 5, 'number')">Displaced</th>
                        <th class="sortable" onclick="sortTable(document.getElementById('vacancyTable'), 6, 'number')">Cascade</th>
                        <th class="sortable" onclick="sortTable(document.getElementById('vacancyTable'), 7, 'number')">Total Available</th>
                        <th class="sortable" onclick="sortTable(document.getElementById('vacancyTable'), 8, 'number')">Applied To</th>
                        <th class="sortable" onclick="sortTable(document.getElementById('vacancyTable'), 9, 'number')">Filled</th>
                        <th class="sortable" onclick="sortTable(document.getElementById('vacancyTable'), 10, 'number')">Remaining</th>
                        <th>Status</th>
                        {% endif %}
                    </tr>
                </thead>
                <tbody>
                    {% for v in vacancies %}
                    <tr>
                        <td>{{ loop.index }}</td>
                        <td class="district-name">{{ v.district }}</td>
                        <td>
                            <input type="number" name="strength_{{ v.district }}" 
                                   class="form-control form-control-sm" 
                                   value="{{ v.total_strength }}" min="0">
                        </td>
                        <td>
                            <input type="number" name="vacancy_{{ v.district }}" 
                                   class="form-control form-control-sm vacancy-input" 
                                   value="{{ v.vacancy_reported }}" min="0"
                                   data-district="{{ v.district }}">
                        </td>
                        <td class="applied-from-count" style="color: #059669;">{{ v.applied_from }}</td>
                        {% if autofill_ran %}
                        <td class="displaced-count" style="color: var(--danger-color);">{{ v.displaced }}</td>
                        <td class="cascade-count" style="color: #8b5cf6;">{{ v.cascade }}</td>
                        <td class="total-available" style="font-weight: 600; color: var(--info-color);">{{ v.total_available }}</td>
                        <td class="applied-to-count" style="color: #0891b2;">{{ v.applied_to }}</td>
                        <td class="filled-count">{{ v.filled }}</td>
                        <td class="remaining-count {% if v.remaining < 0 %}negative{% endif %}">
                            {{ v.remaining }}
                        </td>
                        <td>
                            {% if v.remaining == 0 and v.vacancy_reported > 0 %}
                            <span class="badge badge-success">Filled</span>
                            {% elif v.remaining < 0 %}
                            <span class="badge badge-danger">Over</span>
                            {% elif v.vacancy_reported == 0 %}
                            <span class="badge badge-secondary">No Vacancy</span>
                            {% else %}
                            <span class="badge badge-warning">Open</span>
                            {% endif %}
                        </td>
                        {% endif %}
                    </tr>
                    {% endfor %}
                </tbody>
                <tfoot>
                    <tr class="total-row">
                        <td colspan="2"><strong>Total</strong></td>
                        <td><strong id="total-strength">{{ vacancies|sum(attribute='total_strength') }}</strong></td>
                        <td><strong id="total-vacancy">{{ vacancies|sum(attribute='vacancy_reported') }}</strong></td>
                        <td><strong id="total-applied-from">{{ vacancies|sum(attribute='applied_from') }}</strong></td>
                        {% if autofill_ran %}
                        <td><strong id="total-displaced">{{ vacancies|sum(attribute='displaced') }}</strong></td>
                        <td><strong id="total-cascade">{{ vacancies|sum(attribute='cascade') }}</strong></td>
                        <td><strong id="total-available">{{ vacancies|sum(attribute='total_available') }}</strong></td>
                        <td><strong id="total-applied-to">{{ vacancies|sum(attribute='applied_to') }}</strong></td>
                        <td><strong id="total-filled">{{ vacancies|sum(attribute='filled') }}</strong></td>
                        <td><strong id="total-remaining">{{ vacancies|sum(attribute='remaining') }}</strong></td>
                        <td></td>
                        {% endif %}
                    </tr>
                </tfoot>
            </table>
        </div>
        
        <div class="form-actions">
            <button type="submit" class="btn btn-primary btn-lg">
                <i class="fas fa-save"></i> Save Vacancy Data
            </button>
        </div>
    </form>
    
    <div class="vacancy-summary">
        <h3><i class="fas fa-chart-bar"></i> Summary</h3>
        <div class="summary-cards">
            <div class="summary-card">
                <h4>Total Vacancy</h4>
                <span id="summary-total">{{ vacancies|sum(attribute='vacancy_reported') }}</span>
            </div>
            {% if autofill_ran %}
            <div class="summary-card">
                <h4>Filled</h4>
                <span id="summary-filled">{{ vacancies|sum(attribute='filled') }}</span>
            </div>
            <div class="summary-card">
                <h4>Remaining</h4>
                <span id="summary-remaining">{{ vacancies|sum(attribute='remaining') }}</span>
            </div>
            {% else %}
            <div class="summary-card">
                <h4>Filled</h4>
                <span id="summary-filled" style="color: var(--text-muted);">--</span>
            </div>
            <div class="summary-card">
                <h4>Remaining</h4>
                <span id="summary-remaining" style="color: var(--text-muted);">--</span>
            </div>
            {% endif %}
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
// Auto-calculate totals when vacancy inputs change
document.querySelectorAll('.vacancy-input').forEach(input => {
    input.addEventListener('change', updateTotals);
});

function updateTotals() {
    let totalVacancy = 0;
    document.querySelectorAll('.vacancy-input').forEach(input => {
        totalVacancy += parseInt(input.value) || 0;
    });
    document.getElementById('total-vacancy').textContent = totalVacancy;
    document.getElementById('summary-total').textContent = totalVacancy;
}
</script>
{% endblock %}
